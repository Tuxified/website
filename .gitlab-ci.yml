---

stages:
  - automation
  - deploy

deploy:
  image: ruby:2.5-alpine
  stage: deploy
  variables:
    DISTRIBUTION_ID: E2461OP4YFCUOQ
  before_script:
    - apk add --update build-base nodejs tzdata python3 python3-dev
    - pip3 install awscli
    - gem install bundler --no-doc
    - ruby --version
    - gem --version
    - bundle --version
    - bundle install --path vendor --retry=3
  script:
    - rake deploy
  cache:
    paths:
      - vendor/ruby
  only:
    - master
  environment:
    name: production
    url: https://inko-lang.org

sponsors:
  image: ruby:2.5-alpine
  stage: automation
  before_script:
    - apk add --update build-base tzdata openssh
    - gem install bundler --no-doc
    - ruby --version
    - gem --version
    - bundle --version
    - bundle install --path vendor --retry=3
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo $SSH_PUBLIC_KEY > ~/.ssh/id_ed25519.pub
    - echo $SSH_PRIVATE_KEY > ~/.ssh/id_ed25519
    - ssh-add ~/.ssh/id_ed25519
  script:
    - rake deploy
  cache:
    paths:
      - vendor/ruby
  script:
    - bundle exec rake sponsors:commit
  only:
    refs:
      - schedules
    variables:
      - $UPDATE_SPONSORS
  environment:
    name: production
    url: https://inko-lang.org
